{"componentChunkName":"component---src-layout-post-post-tsx","path":"/post/web/security/xss-csrf/","result":{"data":{"content":{"title":"XSS 与 CSRF 的攻防","description":"XSS 与 CSRF 的攻防","createdAt":"August 19, 2021","updatedAt":null,"timeToRead":"22min 18s","frontmatter2":{"aplayer":null,"wechatThumbnail":null},"toc":{"children":[{"depth":2,"identifier":"heading-前言","contents":[{"type":"text","value":"前言"}],"children":[]},{"depth":2,"identifier":"heading-xss-攻击","contents":[{"type":"text","value":"XSS 攻击"}],"children":[]},{"depth":2,"identifier":"heading-xss-攻击的预防","contents":[{"type":"text","value":"XSS 攻击的预防"}],"children":[{"depth":3,"identifier":"heading-输入过滤","contents":[{"type":"text","value":"输入过滤"}],"children":[]},{"depth":3,"identifier":"heading-纯前端渲染","contents":[{"type":"text","value":"纯前端渲染"}],"children":[]},{"depth":3,"identifier":"heading-其它防御策略","contents":[{"type":"text","value":"其它防御策略"}],"children":[]}]},{"depth":2,"identifier":"heading-csrf-攻击","contents":[{"type":"text","value":"CSRF 攻击"}],"children":[]},{"depth":2,"identifier":"heading-csrf-攻击的防护","contents":[{"type":"text","value":"CSRF 攻击的防护"}],"children":[{"depth":3,"identifier":"heading-同源检测","contents":[{"type":"text","value":"同源检测"}],"children":[]},{"depth":3,"identifier":"heading-csrf-token","contents":[{"type":"text","value":"CSRF Token"}],"children":[]},{"depth":3,"identifier":"heading-其它防御策略-2","contents":[{"type":"text","value":"其它防御策略"}],"children":[]}]},{"depth":2,"identifier":"heading-related","contents":[{"type":"text","value":"Related"}],"children":[]}]},"categories":[],"tags":["web","web security","csrf"],"ast":{"type":"root","children":[{"type":"heading","depth":2,"children":[{"type":"text","value":"前言"}],"identifier":"heading-前言"},{"type":"paragraph","children":[{"type":"text","value":"本文主要参考了美团技术团队的系列文章："}]},{"type":"list","ordered":false,"marker":42,"spread":false,"children":[{"type":"listItem","children":[{"type":"linkReference","identifier":"meituan-1","label":"meituan-1","referenceType":"full","children":[{"type":"text","value":"前端安全系列（一）：如何防止XSS攻击？"}]}]},{"type":"listItem","children":[{"type":"linkReference","identifier":"meituan-2","label":"meituan-2","referenceType":"full","children":[{"type":"text","value":"前端安全系列（二）：如何防止CSRF攻击？"}]}]}]},{"type":"heading","depth":2,"children":[{"type":"text","value":"XSS 攻击"}],"identifier":"heading-xss-攻击"},{"type":"paragraph","children":[{"type":"text","value":"XSS"},{"type":"footnoteReference","identifier":"footnote-1","label":"1"},{"type":"text","value":" (Cross-site Scripting) 跨站脚本攻击，是一种代码注入攻击。攻击者通过在\nweb 页面中插入浏览器上可执行的恶意代码，在用户浏览网页时恶意代码会被浏览器执行，从而完成攻击。"}]},{"type":"paragraph","children":[{"type":"text","value":"根据攻击的来源，XSS 攻击可分为存储型、反射型和 DOM 型三种："}]},{"type":"list","ordered":false,"marker":42,"spread":true,"children":[{"type":"listItem","children":[{"type":"paragraph","children":[{"type":"text","value":"存储型 XSS 攻击步骤"}]},{"type":"list","ordered":true,"orderType":"1","start":1,"marker":46,"spread":false,"children":[{"type":"listItem","children":[{"type":"text","value":"攻击者将恶意代码提交到目标网站的数据库中（如在输入框中输入\n"},{"type":"inlineCode","value":"\"><script>alert('xss')</script>"},{"type":"text","value":"）；"}]},{"type":"listItem","children":[{"type":"text","value":"用户访问目标网站，"},{"type":"strong","children":[{"type":"text","value":"服务端"}]},{"type":"text","value":"从数据库中取出包含恶意代码的数据，未经正确转义就通过模板引擎渲染成 HTML 返回；"}]},{"type":"listItem","children":[{"type":"text","value":"用户浏览器渲染接收到的 HTML，混在其中的恶意代码得到执行。"}]}]}]},{"type":"listItem","children":[{"type":"paragraph","children":[{"type":"text","value":"反射型 XSS 攻击步骤"}]},{"type":"list","ordered":true,"orderType":"1","start":1,"marker":46,"spread":false,"children":[{"type":"listItem","children":[{"type":"text","value":"攻击者构造出特殊的 url，其中包含恶意代码（如\n"},{"type":"inlineCode","value":"https://example.com/?keyword=%3Cscript%3Ealert('xss')%3C/script%3E"},{"type":"text","value":"）；"}]},{"type":"listItem","children":[{"type":"text","value":"用户访问携带恶意代码的 URL，"},{"type":"strong","children":[{"type":"text","value":"服务端"}]},{"type":"text","value":"从 URL 中取出含恶意代码的参数，未经正确转义就通过模板引擎渲染成 HTML 返回；"}]},{"type":"listItem","children":[{"type":"text","value":"用户浏览器渲染接收到的 HTML，混在其中的恶意代码得到执行。"}]}]}]},{"type":"listItem","children":[{"type":"paragraph","children":[{"type":"text","value":"DOM 型 XSS 攻击步骤"}]},{"type":"list","ordered":true,"orderType":"1","start":1,"marker":46,"spread":false,"children":[{"type":"listItem","children":[{"type":"text","value":"攻击者构造出特殊的 url，其中包含恶意代码（如\n"},{"type":"inlineCode","value":"https://example.com/?to=javascript%3Aalert('xss')"},{"type":"text","value":"）；"}]},{"type":"listItem","children":[{"type":"text","value":"用户访问携带恶意代码的 URL，"},{"type":"strong","children":[{"type":"text","value":"前端"}]},{"type":"text","value":"从 URL 中取出含恶意代码的参数，传入特殊的 HTML 属性中（如 "},{"type":"inlineCode","value":"<a href=\"javascript:alert('xss')\">link</a>"},{"type":"text","value":"），在接下来的事件触发中（如点击前一个括号中的链接）恶意代码得到执行。"}]}]}]}]},{"type":"paragraph","children":[{"type":"text","value":"在 web 页面中，脚本注入有很多方法，常见的有："}]},{"type":"list","ordered":false,"marker":42,"spread":true,"children":[{"type":"listItem","children":[{"type":"paragraph","children":[{"type":"text","value":"构造特殊的 url：有些网站会从 url 中拉取参数直接进行字符串拼接；"}]}]},{"type":"listItem","children":[{"type":"paragraph","children":[{"type":"text","value":"特殊的 HTML 属性：如在 "},{"type":"inlineCode","value":"href"},{"type":"text","value":"、"},{"type":"inlineCode","value":"src"},{"type":"text","value":" 属性中，包含 "},{"type":"inlineCode","value":"javascript:"},{"type":"text","value":" 等可执行代码；"}]}]},{"type":"listItem","children":[{"type":"paragraph","children":[{"type":"text","value":"事件回调函数（如 "},{"type":"inlineCode","value":"onload"},{"type":"text","value":"、"},{"type":"inlineCode","value":"onclick"},{"type":"text","value":"）中注入恶意代码；"}]}]},{"type":"listItem","children":[{"type":"paragraph","children":[{"type":"text","value":"在标签属性中包含 "},{"type":"inlineCode","value":"\""},{"type":"text","value":" 或 "},{"type":"inlineCode","value":">"},{"type":"text","value":"，提前关闭属性甚至合法的标签，从而注入额外的属性甚至 HTML 标签。"}]}]}]},{"type":"admonition","keyword":"note","title":[{"type":"text","value":"XSS 攻击举例 节选自 "},{"type":"linkReference","identifier":"meituan-1","label":"meituan-1","referenceType":"full","children":[{"type":"text","value":"前端安全系列（一）：如何防止XSS攻击？"}]}],"children":[{"type":"paragraph","children":[{"type":"text","value":"在早期前后端未分离时，很流行使用 JSP 等模板引擎生成 HTML，很容易忘记对用户输入的数据进行转义，直接通过模板引擎进行字符串拼接，从而产生 XSS 漏洞："}]},{"type":"list","ordered":false,"marker":42,"spread":true,"children":[{"type":"listItem","children":[{"type":"paragraph","children":[{"type":"inlineCode","value":"script"},{"type":"text","value":" 标签"}]},{"type":"code","lang":"jsp","meta":"title=\"xss/example1.jsp\"","value":"<div>keyword: <%= getParameter(\"keyword\") %></div>\n"},{"type":"paragraph","children":[{"type":"text","value":"如上是一段 JSP 代码，如果攻击者分享了一个 url，其内容为\n"},{"type":"inlineCode","value":"https://example.com/?keyword=%3Cscript%3Ealert('xss')%3C/script%3E"},{"type":"text","value":"，则渲染结果为："}]},{"type":"code","lang":"html","meta":"title=\"xss/example1.html\"","value":"<div>keyword: <script>alert('xss')</script></div>\n"},{"type":"paragraph","children":[{"type":"text","value":"url 中包含的 js 代码得到执行。"}]}]},{"type":"listItem","children":[{"type":"paragraph","children":[{"type":"text","value":"内联脚本 "},{"type":"inlineCode","value":"javascript:"},{"type":"text","value":"（这段字符浏览器不区分大小写）"}]},{"type":"code","lang":"jsp","meta":"title=\"xss/example2.jsp\"","value":"<a href=\"<%= getParameter(\"to\") %>\">跳转...</a>\n"},{"type":"paragraph","children":[{"type":"text","value":"同样地，对于面面这段 JSP 代码，若 url 为\n"},{"type":"inlineCode","value":"https://example.com/?to=javascript:alert('xss')"},{"type":"text","value":"，则渲染结果为："}]},{"type":"code","lang":"html","meta":"title=\"xss/example2.html\"","value":"<a href=\"javascript:alert('xss')\">跳转...</a>\n"},{"type":"code","lang":"jsx","meta":"embed","value":"() => (\n  <p \n    className=\"yozora-paragraph\"\n    dangerouslySetInnerHTML={{\n      __html: `你可以点点看这个按钮： <a href=\"javascript:alert('xss')\">跳转...</a>`\n    }} \n  />\n)\n"}]}]}]},{"type":"heading","depth":2,"children":[{"type":"text","value":"XSS 攻击的预防"}],"identifier":"heading-xss-攻击的预防"},{"type":"paragraph","children":[{"type":"text","value":"XSS 攻击有如下特点："}]},{"type":"list","ordered":true,"orderType":"1","start":1,"marker":46,"spread":false,"children":[{"type":"listItem","children":[{"type":"text","value":"攻击者构造并提交恶意代码"}]},{"type":"listItem","children":[{"type":"text","value":"浏览器执行恶意代码"}]}]},{"type":"paragraph","children":[{"type":"text","value":"我们可以针对这些特点进行防御。"}]},{"type":"heading","depth":3,"children":[{"type":"text","value":"输入过滤"}],"identifier":"heading-输入过滤"},{"type":"paragraph","children":[{"type":"text","value":"由于网络服务中所有请求都可以绕过前端直接向服务端发起，因此仅在浏览器端中做输入过滤是不能起到防范xss的效果的。但是后端做输入过滤同样存在问题，原因是不同的客户端及其渲染框架对于要接受的数据的转义规则存在差别，而服务端要做过滤只能选择某一种转义规则，众口难调。贸然进行转义可能会丢失原意。"}]},{"type":"paragraph","children":[{"type":"text","value":"比如一个合法用户提交的内容为 "},{"type":"inlineCode","value":"a < b"},{"type":"text","value":"，后端在写入数据前，将其转义成 "},{"type":"inlineCode","value":"a &lt; b"},{"type":"text","value":"，这在纯 HTML 中渲染是有效的，但如果它是作为一段 url 内容则这个转义会破坏了原意。此外，对于 React / Vue 等现代前端框架，在渲染内容时需要的是原始的字符串内容，转义后的内容无法正确展示。"}]},{"type":"heading","depth":3,"children":[{"type":"text","value":"纯前端渲染"}],"identifier":"heading-纯前端渲染"},{"type":"paragraph","children":[{"type":"text","value":"采用前后端分离的开发模式，前端使用 React / Vue 等现代前端框架进行开发，以 React\n为例："}]},{"type":"list","ordered":false,"marker":42,"spread":true,"children":[{"type":"listItem","children":[{"type":"paragraph","children":[{"type":"text","value":"在不使用 "},{"type":"inlineCode","value":"dangerouslySetInnerHTML"},{"type":"text","value":" 属性渲染数据时，其内部逻辑天然地对 HTML\n进行了严格的转义。"}]}]},{"type":"listItem","children":[{"type":"paragraph","children":[{"type":"text","value":"在代码规范中严禁内联 javascript 的事件注册方式，统一通过 React / jsx 提供的\nEvent Handlers 进行定义（在原始的 html / js 项目中，可以用 "},{"type":"inlineCode","value":".addEventListener"},{"type":"text","value":"\n方法进行事件注册） 函数来注册事件回调函数。"}]}]}]},{"type":"heading","depth":3,"children":[{"type":"text","value":"其它防御策略"}],"identifier":"heading-其它防御策略"},{"type":"admonition","keyword":"note","title":[{"type":"text","value":"节选自 "},{"type":"linkReference","identifier":"meituan-1","label":"meituan-1","referenceType":"full","children":[{"type":"text","value":"前端安全系列（一）：如何防止XSS攻击？"}]}],"children":[{"type":"paragraph","children":[{"type":"text","value":"Content Security Policy\n严格的 CSP 在 XSS 的防范中可以起到以下的作用："}]},{"type":"list","ordered":false,"marker":42,"spread":false,"children":[{"type":"listItem","children":[{"type":"text","value":"禁止加载外域代码，防止复杂的攻击逻辑。"}]},{"type":"listItem","children":[{"type":"text","value":"禁止外域提交，网站被攻击后，用户的数据不会泄露到外域。"}]},{"type":"listItem","children":[{"type":"text","value":"禁止内联脚本执行（规则较严格，目前发现 GitHub 使用）。"}]},{"type":"listItem","children":[{"type":"text","value":"禁止未授权的脚本执行（新特性，Google Map 移动版在使用）。"}]},{"type":"listItem","children":[{"type":"text","value":"合理使用上报可以及时发现 XSS，利于尽快修复问题。"}]}]}]},{"type":"heading","depth":2,"children":[{"type":"text","value":"CSRF 攻击"}],"identifier":"heading-csrf-攻击"},{"type":"paragraph","children":[{"type":"text","value":"CSRF (Cross-site Request Forgery) 跨站请求伪造，是通过诱导受害者访问第三方网站，并在第三方网站中盗用用户在目标网站上的身份（Cookie）发送跨站请求进行攻击的。"}]},{"type":"admonition","keyword":"tip","title":[{"type":"text","value":"CSRF 攻击举例"}],"children":[{"type":"list","ordered":true,"orderType":"1","start":1,"marker":46,"spread":false,"children":[{"type":"listItem","children":[{"type":"text","value":"受害者登录 "},{"type":"inlineCode","value":"a.com"}]},{"type":"listItem","children":[{"type":"text","value":"攻击者引诱受害者访问 "},{"type":"inlineCode","value":"danger.com"},{"type":"text","value":"（攻击者可以利用或控制的站点）"}]},{"type":"listItem","children":[{"type":"text","value":"在 "},{"type":"inlineCode","value":"danger.com"},{"type":"text","value":" 中，向 "},{"type":"inlineCode","value":"a.com"},{"type":"text","value":" 发起一个请求（浏览器默认会携带 "},{"type":"inlineCode","value":"a.com"},{"type":"text","value":" 的 Cookie）"}]},{"type":"listItem","children":[{"type":"inlineCode","value":"a.com"},{"type":"text","value":" 接收到请求，对请求进行验证（校验 Cookie），确认是受害者的凭证后执行请求"}]}]}]},{"type":"paragraph","children":[{"type":"text","value":"发送跨站请求有多种方式："}]},{"type":"list","ordered":false,"marker":42,"spread":true,"children":[{"type":"listItem","children":[{"type":"paragraph","children":[{"type":"text","value":"图片地址：浏览器在渲染页面时会自动访问 "},{"type":"inlineCode","value":"img"},{"type":"text","value":" 元素中指定的 "},{"type":"inlineCode","value":"src"},{"type":"text","value":" 地址来加载图片，它本质上是一个 "},{"type":"inlineCode","value":"GET"},{"type":"text","value":" 请求，如将此地址设置成 "},{"type":"inlineCode","value":"<img src=\"https://bank.com/withdraw?amount=100&to=hacker\">"},{"type":"text","value":"，则在浏览器尝试加载此“图片”时，一次恶意的跨站请求就完成了。"}]}]},{"type":"listItem","children":[{"type":"paragraph","children":[{"type":"text","value":"链接地址：需要诱导用户点击才会触发，如 "},{"type":"inlineCode","value":"<a href=\"https://bank.com/withdraw?amount=100&to=hacker\" />"}]}]},{"type":"listItem","children":[{"type":"paragraph","children":[{"type":"text","value":"提交表单：此攻击方式比较严格，通常需要黑客完全控制第三方站点，可以在其上执行自己的 javascript 脚本，如："}]},{"type":"code","lang":"html","meta":"title=\"csrf/example1.html\" linenos","value":"<form \n  id=\"hack-form\"\n  action=\"https://bank.com/withdraw\"\n  method=\"POST\"\n>\n  <input type=\"hidden\" name=\"amount\" value=\"1000\" />\n  <input type=\"hidden\" name=\"to\" value=\"hacker\" />\n</form>\n\n<script>document.getElementById('hack-form').submit()</script>\n"}]}]},{"type":"heading","depth":2,"children":[{"type":"text","value":"CSRF 攻击的防护"}],"identifier":"heading-csrf-攻击的防护"},{"type":"paragraph","children":[{"type":"text","value":"CSRF 攻击有如下特点："}]},{"type":"list","ordered":false,"marker":42,"spread":true,"children":[{"type":"listItem","children":[{"type":"paragraph","children":[{"type":"text","value":"攻击通常发生在第三方网站。"}]}]},{"type":"listItem","children":[{"type":"paragraph","children":[{"type":"text","value":"攻击通过冒用受害者的登陆凭证发起恶意请求完成，整个阶段中不能获得用户的登录凭证。"}]}]},{"type":"listItem","children":[{"type":"paragraph","children":[{"type":"text","value":"跨站请求十分容易达成，图片、超链接、表单提交，在一些可以发图、链接的第三方平台中可以直接嵌入恶意请求（如在一些支持 Markdown 语法的评论框中内嵌一个恶意的请求地址作为 url 的图片）。"}]},{"type":"paragraph","children":[{"type":"text","value":"如果被攻击的目标站点中有上述容易被利用的功能，则攻击可以直接在本域下进行，此时攻击可以绕过同源策略的防御机制。"}]}]}]},{"type":"paragraph","children":[{"type":"text","value":"我们可以针对这些特点进行防御。"}]},{"type":"heading","depth":3,"children":[{"type":"text","value":"同源检测"}],"identifier":"heading-同源检测"},{"type":"paragraph","children":[{"type":"text","value":"CSRF 攻击大多是利用第三方站点发起恶意请求，因此直接拒绝来自第三方站点的请求进行规避（此方法对于本站下发起的 CSRF 攻击无效）。"}]},{"type":"paragraph","children":[{"type":"text","value":"如何判断请求是否来自外域："}]},{"type":"list","ordered":false,"marker":42,"spread":true,"children":[{"type":"listItem","children":[{"type":"paragraph","children":[{"type":"text","value":"检查 HTTP Header 中的 "},{"type":"inlineCode","value":"Origin"},{"type":"text","value":" 字段"}]},{"type":"admonition","keyword":"caution","title":[{"type":"text","value":"节选自 "},{"type":"linkReference","identifier":"meituan-2","label":"meituan-2","referenceType":"full","children":[{"type":"text","value":"前端安全系列（二）：如何防止CSRF攻击？"}]}],"children":[{"type":"paragraph","children":[{"type":"text","value":"Origin 在以下两种情况下不存在："}]},{"type":"list","ordered":false,"marker":42,"spread":true,"children":[{"type":"listItem","children":[{"type":"paragraph","children":[{"type":"text","value":"IE11 同源策略：IE11 不会在 CORS 请求上添加 Origin 字段。参见\n"},{"type":"link","url":"https://developer.mozilla.org/en-US/docs/Web/Security/Same-origin_policy#IE_Exceptions","children":[{"type":"text","value":"https://developer.mozilla.org/en-US/docs/Web/Security/Same-origin_policy#IE_Exceptions"}]}]}]},{"type":"listItem","children":[{"type":"paragraph","children":[{"type":"text","value":"302 重定向：在 302 重定向之后的请求中，请求头上不包含 Origin 字段。"}]}]}]}]}]},{"type":"listItem","children":[{"type":"paragraph","children":[{"type":"text","value":"检查 HTTP Header 中的 "},{"type":"inlineCode","value":"Referer"},{"type":"footnoteReference","identifier":"footnote-2","label":"2"},{"type":"text","value":" 字段"}]},{"type":"paragraph","children":[{"type":"text","value":"Referer 字段记录了请求的来源地址："}]},{"type":"list","ordered":false,"marker":45,"spread":false,"children":[{"type":"listItem","children":[{"type":"text","value":"对于 ajax 请求以及图片、脚本等资源请求，Referer 为发起请求的页面地址"}]},{"type":"listItem","children":[{"type":"text","value":"对于页面跳转，Referer 为页面历史记录中的上一个页面地址"}]}]},{"type":"admonition","keyword":"info","title":[{"type":"text","value":"节选自 "},{"type":"linkReference","identifier":"mdn-referrer-policy","label":"mdn-Referrer-Policy","referenceType":"full","children":[{"type":"text","value":"Referrer-Policy | MDN"}]}],"children":[{"type":"list","ordered":false,"marker":42,"spread":true,"children":[{"type":"listItem","children":[{"type":"paragraph","children":[{"type":"inlineCode","value":"Referrer-Policy: no-referrer"},{"type":"text","value":":\n整个 Referer 首部会被移除。访问来源信息不随着请求一起发送。"}]}]},{"type":"listItem","children":[{"type":"paragraph","children":[{"type":"inlineCode","value":"Referrer-Policy: no-referrer-when-downgrade"},{"type":"text","value":": （默认值）在没有指定任何策略的情况下用户代理的默认行为。在同等安全级别的情况下，引用页面的地址会被发送(HTTPS->HTTPS)，但是在降级的情况下不会被发送 (HTTPS->HTTP)。"}]}]},{"type":"listItem","children":[{"type":"paragraph","children":[{"type":"inlineCode","value":"Referrer-Policy: origin"},{"type":"text","value":":\n在任何情况下，仅发送文件的源作为引用地址。例如 https"},{"type":"inlineCode","value":"://example.com/page.html"},{"type":"text","value":"\n会将 "},{"type":"inlineCode","value":"https://example.com/"},{"type":"text","value":" 作为引用地址。"}]}]},{"type":"listItem","children":[{"type":"paragraph","children":[{"type":"inlineCode","value":"Referrer-Policy: origin-when-cross-origin"},{"type":"text","value":":\n对于同源的请求，会发送完整的 url 作为引用地址，但是对于非同源请求仅发送文件的源。"}]}]},{"type":"listItem","children":[{"type":"paragraph","children":[{"type":"inlineCode","value":"Referrer-Policy: same-origin"},{"type":"text","value":":\n对于同源的请求会发送引用地址，但是对于非同源请求则不发送引用地址信息。"}]}]},{"type":"listItem","children":[{"type":"paragraph","children":[{"type":"inlineCode","value":"Referrer-Policy: strict-origin"},{"type":"text","value":":\n在同等安全级别的情况下，发送文件的源作为引用地址(HTTPS->HTTPS)，但是在降级的情况下不会发送 (HTTPS->HTTP)。"}]}]},{"type":"listItem","children":[{"type":"paragraph","children":[{"type":"inlineCode","value":"Referrer-Policy: strict-origin-when-cross-origin"},{"type":"text","value":":\n对于同源的请求，会发送完整的URL作为引用地址；在同等安全级别的情况下，发送文件的源作为引用地址(HTTPS->HTTPS)；在降级的情况下不发送此首部 (HTTPS->HTTP)。"}]}]},{"type":"listItem","children":[{"type":"paragraph","children":[{"type":"inlineCode","value":"Referrer-Policy: unsafe-url"},{"type":"text","value":":\n无论是同源请求还是非同源请求，都发送完整的 URL（移除参数信息之后）作为引用地址。"}]},{"type":"admonition","keyword":"caution","title":[],"children":[{"type":"paragraph","children":[{"type":"text","value":"这项设置会将受 TLS 安全协议保护的资源的源和路径信息泄露给非安全的源服务器。进行此项设置的时候要慎重考虑。"}]}]}]}]}]}]}]},{"type":"heading","depth":3,"children":[{"type":"text","value":"CSRF Token"}],"identifier":"heading-csrf-token"},{"type":"paragraph","children":[{"type":"text","value":"前文中提到 CSRF 攻击是利用了浏览器在发送请求时默认携带对应站点的 Cookie 的机制完成的，如果服务器要求所有的请求都需要携带一个 "},{"type":"inlineCode","value":"token"},{"type":"text","value":"，且该 "},{"type":"inlineCode","value":"token"},{"type":"text","value":" 不存在服务器上，则校验此 "},{"type":"inlineCode","value":"token"},{"type":"text","value":" 就可以完全防御 CSRF 攻击了。"}]},{"type":"paragraph","children":[{"type":"text","value":"使用此方法需要在所有的请求中携带一个固定的 "},{"type":"inlineCode","value":"token"},{"type":"text","value":"，可以将其写入在 "},{"type":"inlineCode","value":"html"},{"type":"text","value":" 的某个 "},{"type":"inlineCode","value":"meta"},{"type":"text","value":" 元素中，然后在发起请求时通过 js 查询此 "},{"type":"inlineCode","value":"token"},{"type":"text","value":"；或者在服务端渲染页面时将此 "},{"type":"inlineCode","value":"token"},{"type":"text","value":" 注入到链接（站点链接，非用户填入的链接）和表单中。此外，还可以将\n"},{"type":"inlineCode","value":"token"},{"type":"text","value":" 写入 HTTP Header 中，如使用 "},{"type":"linkReference","identifier":"axios","label":"axios","referenceType":"collapsed","children":[{"type":"text","value":"axios"}]},{"type":"text","value":" 请求库时，可以设置默认的 HTTP Headers。"}]},{"type":"admonition","keyword":"tip","title":[{"type":"linkReference","identifier":"jwt","label":"jwt","referenceType":"collapsed","children":[{"type":"text","value":"jwt"}]}],"children":[{"type":"paragraph","children":[{"type":"text","value":"由于此 "},{"type":"inlineCode","value":"token"},{"type":"text","value":" 是为了防止 CSRF 攻击存在的，仅用来校验请求是否从可信源中发出，而无需在服务器端废止它（仅设置一个过期时间让它自然失效即可），故可以使用 "},{"type":"inlineCode","value":"jwt"},{"type":"text","value":" 来实现，将用户名写进 "},{"type":"inlineCode","value":"jwt"},{"type":"text","value":" 中即可防止攻击者伪造 "},{"type":"inlineCode","value":"token"},{"type":"text","value":"。这样服务器端就无需存储额外的信息了，仅需通过算法进行校验就可以完成验证了。"}]}]},{"type":"heading","depth":3,"children":[{"type":"text","value":"其它防御策略"}],"identifier":"heading-其它防御策略-2"},{"type":"list","ordered":false,"marker":42,"spread":true,"children":[{"type":"listItem","children":[{"type":"paragraph","children":[{"type":"text","value":"双重 Cookie: 在 Cookie 中写入一个随机数（作为 CSRF Token），之后所有的请求中手动在请求参数中携带此随机数，服务器端通过检查 Cookie 中的随机数和请求中的随机数是否一致进行检验。"}]},{"type":"paragraph","children":[{"type":"text","value":"此方法和 CSRF Token 差不多，换汤不换药"}]}]},{"type":"listItem","children":[{"type":"paragraph","children":[{"type":"text","value":"Samesite Cookie: 服务器在 http 请求头上写入 "},{"type":"inlineCode","value":"Set-Cookie: xxxxx; Samesite=Strict"},{"type":"text","value":"\n表示此 Cookie 仅限同站下使用，从根源上杜绝了 CSRF 攻击。"}]}]}]},{"type":"heading","depth":2,"children":[{"type":"text","value":"Related"}],"identifier":"heading-related"},{"type":"list","ordered":false,"marker":42,"spread":false,"children":[{"type":"listItem","children":[{"type":"linkReference","identifier":"meituan-1","label":"meituan-1","referenceType":"full","children":[{"type":"text","value":"前端安全系列（一）：如何防止XSS攻击？"}]}]},{"type":"listItem","children":[{"type":"linkReference","identifier":"meituan-2","label":"meituan-2","referenceType":"full","children":[{"type":"text","value":"前端安全系列（二）：如何防止CSRF攻击？"}]}]},{"type":"listItem","children":[{"type":"link","url":"https://www.ruanyifeng.com/blog/2018/07/json_web_token-tutorial.html","children":[{"type":"text","value":"JSON Web Token 入门教程"}]}]},{"type":"listItem","children":[{"type":"linkReference","identifier":"mdn-referrer-policy","label":"mdn-Referrer-Policy","referenceType":"full","children":[{"type":"text","value":"Referrer-Policy | MDN"}]}]}]}]},"ecmaImports":[],"definitionMap":{"meituan-1":{"type":"definition","identifier":"meituan-1","label":"meituan-1","url":"https://tech.meituan.com/2018/09/27/fe-security.html"},"meituan-2":{"type":"definition","identifier":"meituan-2","label":"meituan-2","url":"https://tech.meituan.com/2018/10/11/fe-security-csrf.html"},"jwt":{"type":"definition","identifier":"jwt","label":"jwt","url":"https://www.ruanyifeng.com/blog/2018/07/json_web_token-tutorial.html"},"axios":{"type":"definition","identifier":"axios","label":"axios","url":"https://github.com/axios/axios"},"mdn-referrer-policy":{"type":"definition","identifier":"mdn-referrer-policy","label":"mdn-Referrer-Policy","url":"https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Referrer-Policy"}},"footnoteDefinitionMap":{"footnote-1":{"type":"footnoteDefinition","identifier":"footnote-1","label":"1","children":[{"type":"paragraph","children":[{"type":"text","value":"为不和层叠样式表（Cascading Styles Sheets, CSS）的缩写混淆，故将跨站脚本攻击缩写写为 XSS。可参见\n"},{"type":"link","url":"https://zh.wikipedia.org/wiki/%E8%B7%A8%E7%B6%B2%E7%AB%99%E6%8C%87%E4%BB%A4%E7%A2%BC","children":[{"type":"text","value":"https://zh.wikipedia.org/wiki/%E8%B7%A8%E7%B6%B2%E7%AB%99%E6%8C%87%E4%BB%A4%E7%A2%BC"}]}]}]},"footnote-2":{"type":"footnoteDefinition","identifier":"footnote-2","label":"2","children":[{"type":"paragraph","children":[{"type":"text","value":"有趣的是，"},{"type":"inlineCode","value":"Referer"},{"type":"text","value":" 实际上是 "},{"type":"inlineCode","value":"Referrer"},{"type":"text","value":" 的错误拼写，难以想象这样低级的错误在制定规范的过程发生并保留了下来，可参见\n"},{"type":"link","url":"https://zh.wikipedia.org/wiki/HTTP%E5%8F%83%E7%85%A7%E4%BD%8D%E5%9D%80","children":[{"type":"text","value":"https://zh.wikipedia.org/wiki/HTTP%E5%8F%83%E7%85%A7%E4%BD%8D%E5%9D%80"}]}]}]}},"fields":{"slug":"/post/web/security/xss-csrf/"}},"previous":{"title":"自然对数底数e","fields":{"slug":"/post/math/calculus/自然对数底数e/"}},"next":{"title":"防抖和节流","fields":{"slug":"/post/algorithm/debounce-and-throttle/"}},"postItems":{"nodes":[{"title":"洗牌问题和 knuth-shuffle 算法","createdAt":"2021-07-22","tags":["shuffle","knuth-shuffle","约瑟夫环"],"fields":{"slug":"/post/algorithm/shuffle/"}},{"title":"编译原理-语法制导翻译实现计算器","createdAt":"2016-06-23","tags":["编译原理","语法制导翻译","计算机"],"fields":{"slug":"/post/fundamentals-of-compiling/exercise/"}},{"title":"编译原理-语法分析","createdAt":"2016-06-18","tags":["编译原理","语法分析","计算机"],"fields":{"slug":"/post/fundamentals-of-compiling/grammar/"}},{"title":"端口管理","createdAt":"2021-06-20","tags":["network","port","ssh","netstat"],"fields":{"slug":"/post/network/端口管理/"}},{"title":"防抖和节流","createdAt":"2021-09-03","tags":["coding","debounce","throttle"],"fields":{"slug":"/post/algorithm/debounce-and-throttle/"}},{"title":"精确覆盖问题和 DLX 算法","createdAt":"2021-07-24","tags":["算法","精确覆盖","DLX 算法"],"fields":{"slug":"/post/algorithm/dlx/"}},{"title":"背包九讲","createdAt":"2021-06-27","tags":["acm","算法","动态规划","背包问题"],"fields":{"slug":"/post/algorithm/knapsack/"}},{"title":"最长公共子序列（LCS）","createdAt":"2021-06-02","tags":["最长公共子序列","LCS"],"fields":{"slug":"/post/algorithm/lcs/"}},{"title":"最长上升子序列（LIS）","createdAt":"2021-06-02","tags":["最长上升子序列","LIS"],"fields":{"slug":"/post/algorithm/lis/"}},{"title":"当你想来一把数独","createdAt":"2021-08-01","tags":["game","sudoku"],"fields":{"slug":"/post/game/sudoku/"}},{"title":"函数的极限","createdAt":"2021-05-09","tags":["math","函数","极限"],"fields":{"slug":"/post/math/calculus/函数的极限/"}},{"title":"自然对数底数e","createdAt":"2021-08-07","tags":["math","函数","极限","自然对数"],"fields":{"slug":"/post/math/calculus/自然对数底数e/"}},{"title":"小球放盒模型","createdAt":"2016-04-22","tags":["math","组合数学"],"fields":{"slug":"/post/math/combinatorial/小球放盒模型/"}},{"title":"不修改数组找出重复的数字","createdAt":"2021-06-29","tags":["quiz","分治","追击"],"fields":{"slug":"/post/quiz/partition/find-duplicate-number/"}},{"title":"统计区间内的线段","createdAt":"2021-07-21","tags":["quiz","扫描线","前缀和","树状数组","线段树"],"fields":{"slug":"/post/quiz/scanning-line/segments/"}},{"title":"CSS 选择器","createdAt":"2020-11-02","tags":["web","frontend","css"],"fields":{"slug":"/post/web/css/selector/"}},{"title":"ECMA 2020 新特性","createdAt":"2021-04-05","tags":["javascript","ecmascript"],"fields":{"slug":"/post/web/javascript/2020/"}},{"title":"ECMA 2021 新特性","createdAt":"2021-04-05","tags":["javascript","ecmascript"],"fields":{"slug":"/post/web/javascript/2021/"}},{"title":"Javascript 踩坑记——继承和原型链","createdAt":"2021-09-05","tags":["studynote","javascript","ecmascript"],"fields":{"slug":"/post/web/javascript/inherit/"}},{"title":"React Reconciliation","createdAt":"2021-06-26","tags":["react","react reconciliation"],"fields":{"slug":"/post/web/react/reconciliation/"}},{"title":"XSS 与 CSRF 的攻防","createdAt":"2021-08-19","tags":["web","web security","csrf"],"fields":{"slug":"/post/web/security/xss-csrf/"}},{"title":"二分图","createdAt":"2016-07-17","tags":["算法","图论","二分图","学习笔记"],"fields":{"slug":"/post/algorithm/graph/bipartite-graph/"}},{"title":"最长回文子串 Manacher 算法","createdAt":"2016-04-18","tags":["算法","字符串","回文串","manacher"],"fields":{"slug":"/post/algorithm/string/manacher/"}},{"title":"树链剖分","createdAt":"2016-04-23","tags":["acm","算法","树链剖分"],"fields":{"slug":"/post/algorithm/tree/tcs/"}},{"title":"伸展树专题","createdAt":"2016-07-03","tags":["acm","Splay","解题报告","专题训练"],"fields":{"slug":"/post/data-structure/bbst/splay/"}},{"title":"组合游戏基础之 SG 函数和 SG 定理","createdAt":"2016-09-04","tags":["组合数学","组合游戏","SG 定理"],"fields":{"slug":"/post/math/combinatorial/SG/"}},{"title":"快速傅里叶变换和雷德算法","createdAt":"2016-04-10","tags":["acm","大数乘法","fft","快速傅里叶变换"],"fields":{"slug":"/post/math/number-theory/fft/"}},{"title":"数论基础之筛法","createdAt":"2016-05-06","tags":["math","数论","素数","欧拉函数","线性筛"],"fields":{"slug":"/post/math/number-theory/sieve/"}},{"title":"数论基础之原根","createdAt":"2016-05-16","tags":["math","数论","原根"],"fields":{"slug":"/post/math/number-theory/原根/"}},{"title":"数论基础之欧拉函数","createdAt":"2016-05-10","tags":["math","数论","既约剩余系","欧拉函数"],"fields":{"slug":"/post/math/number-theory/欧拉函数/"}},{"title":"约瑟夫环问题","createdAt":"2021-07-16","tags":["quiz","经典问题","约瑟夫环"],"fields":{"slug":"/post/quiz/classical/Josephus-ring/"}},{"title":"扔鸡蛋问题","createdAt":"2021-06-20","tags":["quiz","动态规划"],"fields":{"slug":"/post/quiz/dp/egg-drop/"}},{"title":"在 excel 中启用正则表达式","createdAt":"2021-03-29","tags":["excel","tools"],"fields":{"slug":"/post/tool/excel/regex/"}},{"title":"百度之星 2016 解题报告","createdAt":"2016-06-03","tags":["acm","递推","状态压缩","动态规划","字典树","解题报告"],"fields":{"slug":"/post/acm/contest/baiduzhixing/2016/"}},{"title":"51nod-1462 数据结构 -- 解题报告","createdAt":"2016-04-23","tags":["acm","数据结构","树链剖分","线段树","解题报告"],"fields":{"slug":"/post/acm/oj/51nod/1462/"}},{"title":"HDU-5306 Gorgeous Sequence 解题报告","createdAt":"2016-04-09","tags":["acm","数据结构","线段树","解题报告"],"fields":{"slug":"/post/acm/oj/hdu/5306/"}},{"title":"HDU-5574 Colorful Tree 解题报告（原 2015-上海区域赛-C）","createdAt":"2016-04-12","tags":["acm","数据结构","树链剖分","线段树","解题报告"],"fields":{"slug":"/post/acm/oj/hdu/5574/"}},{"title":"HDU-5576 Expection of String 解题报告（原 2015-上海区域赛-E)","createdAt":"2016-04-24","tags":["acm","动态规划","解题报告"],"fields":{"slug":"/post/acm/oj/hdu/5576/"}},{"title":"剑指offer 解题报告","createdAt":"2021-07-15","tags":["专题训练","解题报告"],"fields":{"slug":"/post/acm/oj/nowcoder/jz-offer/"}},{"title":"POJ-1324 Holedox Moving 解题报告","createdAt":"2016-04-13","tags":["acm","bfs","图论","状态压缩","解题报告"],"fields":{"slug":"/post/acm/oj/poj/1324/"}},{"title":"网络流 24 题","createdAt":"2016-07-30","tags":["acm","算法","图论","网络流","二分图","解题报告","专题训练"],"fields":{"slug":"/post/algorithm/graph/network-flow/24-problems/"}},{"title":"网络流基础之最大权闭合图","createdAt":"2016-07-24","tags":["算法","图论","网络流","最大权闭合图"],"fields":{"slug":"/post/algorithm/graph/network-flow/最大权闭合图/"}},{"title":"Dijkstra 算法","createdAt":"2021-05-29","tags":["算法","最短路","单源最短路","dijkstra"],"fields":{"slug":"/post/algorithm/graph/shortest-path/dijkstra/"}},{"title":"Custom React Hooks","createdAt":"2020-10-29","tags":["react","react hooks"],"fields":{"slug":"/post/web/react/hooks/custom/"}},{"title":"2016 多校第 2 场","createdAt":"2016-07-22","tags":["acm","训练赛","数据结构","解题报告"],"fields":{"slug":"/post/acm/contest/multi-university-training/2016/2/"}},{"title":"CCF 2015-09 最佳文章 解题报告","createdAt":"2016-06-26","tags":["acm","Aho-Corasick 自动机","矩阵快速幂","动态规划","解题报告"],"fields":{"slug":"/post/acm/oj/ccf/2015/09/E/"}},{"title":"数论基础之模方程初步","createdAt":"2016-05-04","tags":["math","数论","扩展欧几里得算法","中国剩余定理","Baby Step Gaint Step"],"fields":{"slug":"/post/math/number-theory/模方程/basic/"}}]}},"pageContext":{"id":"d2ba21f3-2b2d-58a6-b913-856831a58ccf","contentType":"post","paginationUrl":"/posts","previousPostId":"3f476876-2c59-5f5d-bc07-b0a16795ef72","nextPostId":"30ee281f-ea2b-5379-95f6-b8d932190113"}},"staticQueryHashes":[],"slicesMap":{}}